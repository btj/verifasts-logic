\documentclass{article}

\usepackage{xcolor}

\title{VeriFast's separation logic: a higher-order(ish) logic without laters for modular verification of fine-grained concurrent programs}

\author{Bart Jacobs\\
{\small KU Leuven, Dept. CS, DistriNet Research Group}\\
{\small \textsf{bart.jacobs@cs.kuleuven.be}}}

\definecolor{ghost}{HTML}{CC6600}

\newcommand{\gmapsto}{\mapsto_\mathsf{g}}
\newcommand{\annot}[1]{{\color{blue} #1}}
\newcommand{\ghost}[1]{{\color{ghost} #1}}

\begin{document}

\maketitle

\begin{abstract}
We present the separation logic of our VeriFast tool for modular verification of single-threaded and multithreaded C, Java, and Rust programs. Since the complexities of the programming language are orthogonal to the logic, we present the logic in the context of a simple concurrent programming language.
\end{abstract}

\section{Programming language}

\begin{figure}
$$\begin{array}{l}
\mathbf{let}\ \mathsf{x} = \mathbf{cons}(0)\ \mathbf{in}\\
(\\
\quad \mathbf{FAA}(\mathsf{x}, 1)\\
||\\
\quad \mathbf{FAA}(\mathsf{x}, 1)\\
);\\
\mathbf{let}\ \mathsf{v} = {*}\mathsf{x}\ \mathbf{in}\\
\mathbf{assert}\ \mathsf{v} = 2
\end{array}$$
\caption{An example program}\label{fig:example}
\end{figure}

\begin{figure}
$$\ghost{\begin{array}{@{} l @{}}
\mathbf{lem\_type}\ \mathsf{FAA\_op}(\mathsf{x}, \mathsf{n}, \mathsf{P}, \mathsf{Q}) = \mathbf{lem}()\\
\quad \mathbf{forall}\ \mathsf{v}\\
\quad \mathbf{req}\ \mathsf{x} \mapsto \mathsf{v} * \mathsf{P}()\\
\quad \mathbf{ens}\ \mathsf{x} \mapsto \mathsf{v} + \mathsf{n} * \mathsf{Q}()\\
\mathbf{lem\_type}\ \mathsf{FAA\_ghop}(\mathsf{x}, \mathsf{n}, \mathsf{pre}, \mathsf{post}) = \mathbf{lem}(\mathsf{op})\\
\quad \mathbf{forall}\ \mathsf{P}, \mathsf{Q}\\
\quad \mathbf{req}\ \mathbf{atomic\_spaces}(\emptyset) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, \mathsf{n}, \mathsf{P}, \mathsf{Q}) * \mathsf{P}() * \mathsf{pre}()\\
\quad \mathbf{ens}\ \mathbf{atomic\_spaces}(\emptyset) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, \mathsf{n}, \mathsf{P}, \mathsf{Q}) * \mathsf{Q}() * \mathsf{post}()\\
\end{array}}$$
\caption{The ghost prelude (built-in ghost declarations)}
\end{figure}

\begin{figure}
$$\begin{array}{l}
\ghost{\begin{array}{@{} l @{}}
\mathbf{fix}\ \mathsf{Nx}() = \mathsf{cons}(0, \mathsf{nil})\\
\mathbf{pred\_ctor}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() = \exists \mathsf{v1}, \mathsf{v2}.\;[1/2]\mathsf{g1} \gmapsto \mathsf{v1} * [1/2]\mathsf{g2} \gmapsto \mathsf{v2} * \mathsf{x} \mapsto \mathsf{v1} + \mathsf{v2}\\
\mathbf{pred\_ctor}\ \mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() = [1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 0\\
\mathbf{pred\_ctor}\ \mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() = [1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 1\\
\mathbf{pred\_ctor}\ \mathsf{pre2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() = [1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g2} \gmapsto 0\\
\mathbf{pred\_ctor}\ \mathsf{post2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() = [1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g2} \gmapsto 1
\end{array}}\\
\\
\mathbf{let}\ \mathsf{x} = \mathbf{cons}(0)\ \mathbf{in}\\
\ghost{\mathbf{glet}\ \mathsf{g1} = \mathbf{gcons}(0)\ \mathbf{in}}\\
\ghost{\mathbf{glet}\ \mathsf{g2} = \mathbf{gcons}(0)\ \mathbf{in}}\\
\ghost{\mathbf{close}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();}\\
\ghost{\mathbf{create\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));}\\
(\\
\quad \ghost{\begin{array}{@{} l @{}}
\mathbf{produce\_lem\_ptr\_chunk}\ \mathsf{FAA\_ghop}(\mathsf{x}, 1, \mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}), \mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}))(\mathsf{op})\ \{\\
\quad \mathbf{open}\ \mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\\
\quad \mathbf{open\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));\ \mathbf{open}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\\
\quad \mathsf{op}();\\
\quad *\mathsf{g1} \leftarrow_\mathsf{g} 1;\\
\quad \mathbf{close}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\ \mathbf{close\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));\\
\quad \mathbf{close}\ \mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})()\\
\};
\end{array}}\\
\quad \ghost{\mathbf{close}\ \mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();}\\
\quad \mathbf{FAA}(\mathsf{x}, 1);\\
\quad \ghost{\mathbf{open}\ \mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})()}\\
||\\
\quad \ghost{\begin{array}{@{} l @{}}
\mathbf{produce\_lem\_ptr\_chunk}\ \mathsf{FAA\_ghop}(\mathsf{x}, 1, \mathsf{pre2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}), \mathsf{post2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}))(\mathsf{op})\ \{\\
\quad \mathbf{open}\ \mathsf{pre2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\\
\quad \mathbf{open\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));\ \mathbf{open}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\\
\quad \mathsf{op}();\\
\quad *\mathsf{g2} \leftarrow_\mathsf{g} 1;\\
\quad \mathbf{close}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\ \mathbf{close\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));\\
\quad \mathbf{close}\ \mathsf{post2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})()\\
\};
\end{array}}\\
\quad \ghost{\mathbf{close}\ \mathsf{pre2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();}\\
\quad \mathbf{FAA}(\mathsf{x}, 1);\\
\quad \ghost{\mathbf{open}\ \mathsf{post2}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})()}\\
);\\
\ghost{\mathbf{destroy\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));}\\
\ghost{\mathbf{open}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();}\\
\mathbf{let}\ \mathsf{v} = {*}\mathsf{x}\ \mathbf{in}\\
\mathbf{assert}\ \mathsf{v} = 2
\end{array}$$
\caption{VeriFast proof of the example program}\label{fig:example}
\end{figure}

\begin{figure}
$$\begin{array}{l}
\annot{\{\mathbf{emp}\}}\\
\mathbf{let}\ \mathsf{x} = \mathbf{cons}(0)\ \mathbf{in}\ \ghost{\mathbf{glet}\ \mathsf{g1} = \mathbf{gcons}(0)\ \mathbf{in}}\ \ghost{\mathbf{glet}\ \mathsf{g2} = \mathbf{gcons}(0)\ \mathbf{in}}\\
\annot{\{\mathsf{x} \mapsto 0 * \mathsf{g1} \gmapsto 0 * \mathsf{g2} \gmapsto 0\}}\\
\ghost{\mathbf{close}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();}\\
\annot{\{\mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() * [1/2]\mathsf{g1} \gmapsto 0 * [1/2]\mathsf{g2} \gmapsto 0\}}\\
\ghost{\mathbf{create\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));}\\
\annot{\{\mathbf{atomic\_space}(\mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 0 * [1/2]\mathsf{g2} \gmapsto 0\}}\\
(\\
\quad \annot{\{[1/2]\mathbf{atomic\_space}(\mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 0\}}\\
\quad \ghost{\begin{array}{@{} l @{}}
\mathbf{glet}\ \mathsf{lem} = \mathbf{produce\_lem\_ptr\_chunk}\ \mathsf{FAA\_ghop}(\mathsf{x}, 1, \mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}), \mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}))(\mathsf{op})\ \{\\
\quad \annot{\textrm{For all $\mathsf{P}, \mathsf{Q},$}}\\
\quad \annot{\{\mathbf{atomic\_spaces}(\emptyset) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{P}() * \mathsf{pre1}()\}}\\
\quad \mathbf{open}\ \mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\\
\quad \annot{\left\{\begin{array}{l}
\mathbf{atomic\_spaces}(\emptyset) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{P}() * {}\\
{}[1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 0
\end{array}\right\}}\\
\quad \mathbf{open\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));\ \mathbf{open}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\\
\quad \annot{\left\{\begin{array}{l}
\exists \mathsf{v2}.\;\mathbf{atomic\_spaces}(\{(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})\}) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{P}() * {}\\
{}[1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * \mathsf{g1} \gmapsto 0 * [1/2]\mathsf{g2} \gmapsto \mathsf{v2} * \mathsf{x} \mapsto \mathsf{v2}
\end{array}\right\}}\\
\quad \annot{\textrm{For all $\mathsf{v2}$,}}\\
\quad \annot{\left\{\begin{array}{l}
\mathbf{atomic\_spaces}(\{(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})\}) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{P}() * {}\\
{}[1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * \mathsf{g1} \gmapsto 0 * [1/2]\mathsf{g2} \gmapsto \mathsf{v2} * \mathsf{x} \mapsto \mathsf{v2}
\end{array}\right\}}\\
\quad \mathsf{op}();\\
\quad \annot{\left\{\begin{array}{l}
\mathbf{atomic\_spaces}(\{(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})\}) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{Q}() * {}\\
{}[1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * \mathsf{g1} \gmapsto 0 * [1/2]\mathsf{g2} \gmapsto \mathsf{v2} * \mathsf{x} \mapsto 1 + \mathsf{v2}
\end{array}\right\}}\\
\quad *\mathsf{g1} \leftarrow_\mathsf{g} 1;\\
\quad \annot{\left\{\begin{array}{l}
\mathbf{atomic\_spaces}(\{(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})\}) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{Q}() * {}\\
{}[1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * \mathsf{g1} \gmapsto 1 * [1/2]\mathsf{g2} \gmapsto \mathsf{v2} * \mathsf{x} \mapsto 1 + \mathsf{v2}
\end{array}\right\}}\\
\quad \mathbf{close}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();\ \mathbf{close\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));\\
\quad \annot{\left\{\begin{array}{l}
\mathbf{atomic\_spaces}(\emptyset) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{Q}() * {}\\
{}[1/2]\mathbf{atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 1
\end{array}\right\}}\\
\quad \mathbf{close}\ \mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})()\\
\quad \annot{\{\mathbf{atomic\_spaces}(\emptyset) * \mathsf{op} : \mathsf{FAA\_op}(\mathsf{x}, 1, \mathsf{P}, \mathsf{Q}) * \mathsf{Q}() * \mathsf{post1}()\}}\\
\};
\end{array}}\\
\quad \annot{\{[1/2]\mathbf{atomic\_space}(\mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 0 * \mathsf{lem} : \mathsf{FAA\_ghop}(\mathsf{x}, 1, \mathsf{pre1}, \mathsf{post1})\}}\\
\quad \ghost{\mathbf{close}\ \mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();}\\
\quad \annot{\{\mathsf{pre1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() * \mathsf{lem} : \mathsf{FAA\_ghop}(\mathsf{x}, 1, \mathsf{pre1}, \mathsf{post1})\}}\\
\quad \mathbf{FAA}(\mathsf{x}, 1);\\
\quad \annot{\{\mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})() * \mathsf{lem} : \mathsf{FAA\_ghop}(\mathsf{x}, 1, \mathsf{pre1}, \mathsf{post1})\}}\\
\quad \ghost{\mathbf{open}\ \mathsf{post1}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})()}\\
\quad \annot{\{[1/2]\mathbf{atomic\_space}(\mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 1\}}\\
||\\
\quad \dots\\
);\\
\annot{\{\mathbf{atomic\_space}(\mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})) * [1/2]\mathsf{g1} \gmapsto 1 * [1/2]\mathsf{g2} \gmapsto 1\}}\\
\ghost{\mathbf{destroy\_atomic\_space}(\mathsf{Nx}, \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2}));}\ \ghost{\mathbf{open}\ \mathsf{Inv}(\mathsf{x}, \mathsf{g1}, \mathsf{g2})();}\\
\annot{\{\mathsf{g1} \gmapsto 1 * \mathsf{g2} \gmapsto 1 * \mathsf{x} \mapsto 2\}}\\
\mathbf{let}\ \mathsf{v} = {*}\mathsf{x}\ \mathbf{in}\\
\mathbf{assert}\ \mathsf{v} = 2
\end{array}$$
\caption{An example using a function as a value and fine-grained concurrency}\label{fig:example}
\end{figure}

\end{document}
